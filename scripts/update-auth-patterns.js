#!/usr/bin/env node

/**
 * Script to help update auth patterns across Supabase functions
 * This script identifies functions that need updating and provides guidance
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const FUNCTIONS_DIR = path.join(__dirname, '..', 'supabase', 'functions');

function findFunctionsWithWildcardCORS() {
  const functions = [];
  const dirs = fs.readdirSync(FUNCTIONS_DIR, { withFileTypes: true })
    .filter(dirent => dirent.isDirectory())
    .map(dirent => dirent.name);

  for (const funcName of dirs) {
    const indexPath = path.join(FUNCTIONS_DIR, funcName, 'index.ts');
    if (fs.existsSync(indexPath)) {
      const content = fs.readFileSync(indexPath, 'utf8');
      if (content.includes('"Access-Control-Allow-Origin": "*"')) {
        functions.push(funcName);
      }
    }
  }

  return functions;
}

function findFunctionsWithRepeatedAuth() {
  const functions = [];
  const dirs = fs.readdirSync(FUNCTIONS_DIR, { withFileTypes: true })
    .filter(dirent => dirent.isDirectory())
    .map(dirent => dirent.name);

  for (const funcName of dirs) {
    const indexPath = path.join(FUNCTIONS_DIR, funcName, 'index.ts');
    if (fs.existsSync(indexPath)) {
      const content = fs.readFileSync(indexPath, 'utf8');
      // Skip functions we've already updated
      if (funcName === 'create-conversation-with-title' || funcName === 'check-subscription') {
        continue;
      }
      if (content.includes('auth.getUser(') && !content.includes('withAuth')) {
        functions.push(funcName);
      }
    }
  }

  return functions;
}

function generateUpdateScript(functions) {
  let script = `#!/bin/bash

# Script to update auth patterns in Supabase functions
# Generated by update-auth-patterns.js

echo "Updating auth patterns in ${functions.length} functions..."

`;

  for (const func of functions) {
    script += `echo "Updating ${func}..."
# Add imports
sed -i '1a import { withStandardHandling, withAuth, HttpError } from "../_shared/authHelper.ts";' supabase/functions/${func}/index.ts

# Replace CORS headers (this is a simplified replacement - manual review needed)
# sed -i 's/const corsHeaders = {/const corsHeaders = getSecureCorsHeaders(req);/g' supabase/functions/${func}/index.ts

echo "${func} updated"
`;
  }

  script += `
echo "Auth pattern updates complete!"
echo "Note: Manual review and testing required for each function"
`;

  return script;
}

function main() {
  console.log('ðŸ” Analyzing Supabase functions for auth pattern issues...\n');

  const wildcardCORSFunctions = findFunctionsWithWildcardCORS();
  console.log(`ðŸ“‹ Functions using wildcard CORS (*): ${wildcardCORSFunctions.length}`);
  wildcardCORSFunctions.forEach(func => console.log(`   - ${func}`));

  console.log('');

  const repeatedAuthFunctions = findFunctionsWithRepeatedAuth();
  console.log(`ðŸ” Functions with repeated auth logic: ${repeatedAuthFunctions.length}`);
  repeatedAuthFunctions.forEach(func => console.log(`   - ${func}`));

  console.log('\nðŸ“ Generating update script...');
  const updateScript = generateUpdateScript([...new Set([...wildcardCORSFunctions, ...repeatedAuthFunctions])]);

  fs.writeFileSync(path.join(__dirname, 'bulk-update-auth.sh'), updateScript);
  console.log('âœ… Update script generated: scripts/bulk-update-auth.sh');

  console.log('\nðŸŽ¯ Next steps:');
  console.log('1. Review the generated script');
  console.log('2. Run the script: chmod +x scripts/bulk-update-auth.sh && ./scripts/bulk-update-auth.sh');
  console.log('3. Manually review and test each updated function');
  console.log('4. Update functions that need conversation access to use withConversationAuth');

  console.log('\nðŸ“š Pattern for manual updates:');
  console.log('1. Add: import { withStandardHandling, withAuth, HttpError } from "../_shared/authHelper.ts";');
  console.log('2. Remove wildcard CORS headers');
  console.log('3. Wrap handler with: withStandardHandling(req, () => withAuth(req, handler))');
  console.log('4. Remove manual auth.getUser() calls from handler');
}

if (import.meta.url === `file://${process.argv[1]}`) {
  main();
}

// Export functions for use in other scripts if needed
export { findFunctionsWithWildcardCORS, findFunctionsWithRepeatedAuth };
